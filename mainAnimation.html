<!DOCTYPE html>  
<html lang="en">  
<head>  
  <meta charset="UTF-8">  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script type="text/javascript" src="./libs/jquery.keyframes.min.js"></script>
  <script src="./data/accXaccZCOMBINEDMOTIONS.json"></script> 

  <script type='text/javascript'>
    var i            = 0;
    let accX         = 0;
    let accZ         = 0;
    var valid        = 2;
    const accArrayX  = Array.from({length: 1}).fill(0);
    const accArrayZ  = Array.from({length: 1}).fill(0);
    const dispArrayX = Array.from({length: 1}).fill(0);
    const dispArrayZ = Array.from({length: 1}).fill(0);
    var data         = JSON.parse(JSON.stringify(data));


    async function myLoop (data) {
      function tick (obj) {
        return new Promise((resolve, reject) => {
          setTimeout(() => resolve({
            acceleration_x: obj.accX,
            acceleration_z: obj.accZ,
            timestamp: obj.time
          }), 500)
        });
      }

      /* -------------------------------------
         feed the data to the keyframe here
         ------------------------------------- */
      for (let ele of data) {
        keyframe = await tick(ele);

        valid++;
        accX = keyframe.acceleration_x;
        accZ = keyframe.acceleration_z;
        time = keyframe.timestamp;
        accArrayX[0] = accX;
        accArrayZ[0] = accZ;

        // compute the displacement by double integrating the acceleration for accZ (e.i. Up and down movement)
        const deltaTime = valid - 1; // convert time from second per day to second
        const velocityInitialZ = ((accArrayX[0]) / 2) * deltaTime; // compute initialVelocity two step backward
        const velocityCurrentZ = velocityInitialZ + ((accArrayX[0]) / 2) *deltaTime; // compute currentVelocity one step backward                
        const previousDispZ = dispArrayZ[0] + (deltaTime * ((velocityCurrentZ + velocityInitialZ) / 2));
        dispArrayZ[0] = previousDispZ;
        const dispCurrentZ = previousDispZ + dispArrayZ[0];

        // compute the displacement by double integrating the acceleration for accX (e.i. Right and left movement)
        const velocityInitialX = ((accArrayZ[0]) / 2) * deltaTime; // compute initialVelocity two steps backward
        const velocityCurrentX = velocityInitialX + ((accArrayZ[0]) / 2) *deltaTime; // compute currentVelocity one step backward                
        const previousDispX = dispArrayX[0] + (deltaTime * ((velocityCurrentX + velocityInitialX) / 2));
        dispArrayX[0] = previousDispX;
        const dispCurrentX = previousDispX + dispArrayX[0];

        const finaldispX = (dispCurrentX / 5000) * (20 ** -2);
        const finaldispZ = -(dispCurrentZ / 2000) * (20 ** -2);

        console.log("dispX: ", finaldispX.toFixed(7)," dispZ: ", finaldispZ.toFixed(7));
      };
    }
    
    $(document).ready(function() {
      myLoop(data)

      $('.wheel1').css({'width': '210px','top': '-303px','left': '420px','position': 'relative','transform-origin': 'center'});
      $('.wheel2').css({'width': '210px','top': '-485px','left': '195px','position': 'relative','transform-origin': 'center'});
        $.keyframe.define([{
            name: 'carMove',
            '100%': {
                'transform': 'translateX(-500vw)'
            }
          }, {
            name: 'wheelRotation',
            '100%': {
                'transform': 'rotate(360deg)'
            }
            },
            {
              name: 'shake',
              '0%': {
                'transform': 'translateY(-5px)'
              },
              '50%': {
                'transform': 'translateY(5px)'
              },
              '100%': {
                'transform': 'translateY(-5px)'
            }  
        }]);
    });

    function play(animation) {
      
      $('.wheel1').css({'width': '210px','top': '220px','left': '420px','position': 'fixed','transform-origin': 'center'});
      $('.wheel2').css({'width': '210px','top': '220px','left': '195px','position': 'fixed','transform-origin': 'center'});
      
        $('.track').resetKeyframe(function() {
            switch (animation) {
                case 'normal':
                $('.wheel').playKeyframe({
                    name: 'wheelRotation',
                    duration: "2000ms",
                    timingFunction: 'linear',
                    iterationCount: 'infinite'
                  });

                $('.track').playKeyframe({
                    name: 'carMove',
                    duration: "10s",
                    timingFunction: 'linear',
                    iterationCount: 'infinite',
                    direction: 'normal',
                    fillMode: 'forwards'
                  });

                  $('.car').playKeyframe({
                    name: 'shake',
                    duration: "10s",
                    timingFunction: 'linear',
                    iterationCount: 'infinite',
                    direction: 'normal',
                    fillMode: 'forwards'
                  });
                break;
            }
            
        })
    }

    function pause() {
        // freeze keyframe animation and kill callback
        $('.track').pauseKeyframe();
        $('.car').pauseKeyframe();
        $('.wheel1').pauseKeyframe();
        $('.wheel2').pauseKeyframe();
    }

    function resume() {
        // resume keyframe animation
        $('.track').resumeKeyframe();
        $('.car').resumeKeyframe();
        $('.wheel1').resumeKeyframe();
        $('.wheel2').resumeKeyframe();
      }

  </script>  

  <style>
    *{
        margin:  0;
        padding: 0;
    }
    body{
      text-align: center;
    }
    .sky{
        height:100vh;
        width:800vw;
        background-color: rgb(250, 207, 142);
        background-repeat: repeat-x;
        position: absolute;
    }
    .track{
        height:80vh;
        width:10000vw;
        position:absolute;
        top:70vh;
        background-repeat: repeat-x;
        background-image: url(./img/track.png);
    }
    .car{
        height: 1px;
        width: 800px;
        background-image: url(./img/miningtruck.png);
        background-size: cover;
        background-repeat: no-repeat;
        position: absolute;
        left: 600px;
        bottom:55vh;
    }
  </style> 

</head>  
<body>  
  <div class="container"> 
    <input type="button" onclick="play('normal')" value="Start Motion" />
    <input type="button" onclick="pause()" value="Stop Motion" />
    <!-- <input type="button" onclick="resume()" value="Stop Motion" /> -->
    <div class="sky">  
      <div class="track"></div>  
      <div class="car"> 
          <img class="mining-truck" src="./img/miningtruck.png"> 
        <div class="wheel wheel1">  
          <img src="./img/car_wheel_left.png" alt="">  
        </div>  
        <div class="wheel wheel2">  
          <img src="./img/car_wheel_right.png" alt="">  
        </div>  
      </div>  
    </div>  
  </div>
</body>  
</html> 